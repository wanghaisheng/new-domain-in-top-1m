name: Historical Data Import

on:
  workflow_dispatch:  # 仅允许手动触发
    inputs:
      start_date:
        description: '开始日期 (YYYY-MM-DD)'
        required: false
        default: '2024-06-08'
      end_date:
        description: '结束日期 (YYYY-MM-DD)'
        required: false
        default: ''
      start_chunk:
        description: '开始处理的块ID'
        required: false
        default: ''
      end_chunk:
        description: '结束处理的块ID'
        required: false
        default: ''
      batch_size:
        description: '每批处理的域名数量'
        required: false
        default: '5000'
      retry_failed:
        description: '重试失败的块 (true/false)'
        required: false
        default: 'false'

jobs:
  import_historical_data:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4 psutil gitpython pandas pyarrow

      # 准备提交列表
      - name: Prepare commit list
        run: |
          python prepare_commits.py --start-date "${{ github.event.inputs.start_date }}" --end-date "${{ github.event.inputs.end_date }}"

      # 运行分块导入
      - name: Run chunked import
        run: |
          RETRY_FLAG=""
          if [ "${{ github.event.inputs.retry_failed }}" = "true" ]; then
            RETRY_FLAG="--retry-failed"
          fi
          
          START_CHUNK=""
          if [ ! -z "${{ github.event.inputs.start_chunk }}" ]; then
            START_CHUNK="--start-chunk ${{ github.event.inputs.start_chunk }}"
          fi
          
          END_CHUNK=""
          if [ ! -z "${{ github.event.inputs.end_chunk }}" ]; then
            END_CHUNK="--end-chunk ${{ github.event.inputs.end_chunk }}"
          fi
          
          python run_chunked_import.py $START_CHUNK $END_CHUNK --batch-size ${{ github.event.inputs.batch_size }} $RETRY_FLAG

      # 提交结果
      - name: Commit results
        run: |
          python commit_results.py

      - name: Push changes
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: main